# FA-3 Mapping Configuration
# Maps CSV columns to FA-3 XML XPath expressions

# Namespace definitions
namespaces:
  fa3: "http://crd.gov.pl/wzor/2023/06/29/12648/"
  tns: "http://crd.gov.pl/wzor/2023/06/29/12648/"

# Root element mapping
root_element: "tns:FA"

# Field mappings from CSV columns to FA-3 XPath
fields:
  # Invoice header information
  invoice_number:
    xpath: "tns:NrFaktury"
    type: "string"
    required: true
    description: "Numer faktury"
    
  issue_date:
    xpath: "tns:DataWystawienia"
    type: "date"
    required: true
    format: "%Y-%m-%d"
    description: "Data wystawienia faktury"
    
  sale_date:
    xpath: "tns:DataSprzedazy"
    type: "date"
    required: true
    format: "%Y-%m-%d"
    description: "Data sprzedaży"
    
  due_date:
    xpath: "tns:TerminPlatnosci"
    type: "date"
    required: false
    format: "%Y-%m-%d"
    description: "Termin płatności"
    
  # Seller information
  seller_nip:
    xpath: "tns:Sprzedawca/tns:NIP"
    type: "string"
    required: true
    pattern: "^[0-9]{10}$"
    description: "NIP sprzedawcy"
    
  seller_name:
    xpath: "tns:Sprzedawca/tns:Nazwa"
    type: "string"
    required: true
    description: "Nazwa sprzedawcy"
    
  seller_street:
    xpath: "tns:Sprzedawca/tns:Adres/tns:Ulica"
    type: "string"
    required: true
    description: "Ulica sprzedawcy"
    
  seller_city:
    xpath: "tns:Sprzedawca/tns:Adres/tns:Miejscowosc"
    type: "string"
    required: true
    description: "Miejscowość sprzedawcy"
    
  seller_postal_code:
    xpath: "tns:Sprzedawca/tns:Adres/tns:KodPocztowy"
    type: "string"
    required: true
    pattern: "^[0-9]{2}-[0-9]{3}$"
    description: "Kod pocztowy sprzedawcy"
    
  seller_country:
    xpath: "tns:Sprzedawca/tns:Adres/tns:Kraj"
    type: "string"
    required: false
    default: "PL"
    description: "Kraj sprzedawcy"
    
  # Buyer information
  buyer_nip:
    xpath: "tns:Nabywca/tns:NIP"
    type: "string"
    required: true
    pattern: "^[0-9]{10}$"
    description: "NIP nabywcy"
    
  buyer_name:
    xpath: "tns:Nabywca/tns:Nazwa"
    type: "string"
    required: true
    description: "Nazwa nabywcy"
    
  buyer_street:
    xpath: "tns:Nabywca/tns:Adres/tns:Ulica"
    type: "string"
    required: true
    description: "Ulica nabywcy"
    
  buyer_city:
    xpath: "tns:Nabywca/tns:Adres/tns:Miejscowosc"
    type: "string"
    required: true
    description: "Miejscowość nabywcy"
    
  buyer_postal_code:
    xpath: "tns:Nabywca/tns:Adres/tns:KodPocztowy"
    type: "string"
    required: true
    pattern: "^[0-9]{2}-[0-9]{3}$"
    description: "Kod pocztowy nabywcy"
    
  buyer_country:
    xpath: "tns:Nabywca/tns:Adres/tns:Kraj"
    type: "string"
    required: false
    default: "PL"
    description: "Kraj nabywcy"
    
  # Invoice items (array mapping)
  items:
    xpath: "tns:Fa/tns:Faktura/tns:PozycjeFaktury"
    type: "array"
    required: true
    item_mapping:
      item_name:
        xpath: "tns:PozycjaFaktury/tns:Nazwa"
        type: "string"
        required: true
        description: "Nazwa pozycji"
        
      item_quantity:
        xpath: "tns:PozycjaFaktury/tns:Ilosc"
        type: "decimal"
        required: true
        description: "Ilość"
        
      item_unit:
        xpath: "tns:PozycjaFaktury/tns:JednostkaMiary"
        type: "string"
        required: true
        default: "szt"
        description: "Jednostka miary"
        
      item_net_price:
        xpath: "tns:PozycjaFaktury/tns:CenaJednostkowa"
        type: "decimal"
        required: true
        description: "Cena jednostkowa netto"
        
      item_vat_rate:
        xpath: "tns:PozycjaFaktury/tns:StawkaPodatku"
        type: "decimal"
        required: true
        description: "Stawka VAT"
        
      item_net_amount:
        xpath: "tns:PozycjaFaktury/tns:WartoscNetto"
        type: "decimal"
        required: true
        description: "Wartość netto"
        
      item_vat_amount:
        xpath: "tns:PozycjaFaktury/tns:WartoscVAT"
        type: "decimal"
        required: true
        description: "Wartość VAT"
        
      item_gross_amount:
        xpath: "tns:PozycjaFaktury/tns:WartoscBrutto"
        type: "decimal"
        required: true
        description: "Wartość brutto"
  
  # Invoice totals
  total_net_amount:
    xpath: "tns:Fa/tns:Faktura/tns:Podsumowanie/tns:WartoscNetto"
    type: "decimal"
    required: true
    description: "Suma wartości netto"
    
  total_vat_amount:
    xpath: "tns:Fa/tns:Faktura/tns:Podsumowanie/tns:WartoscVAT"
    type: "decimal"
    required: true
    description: "Suma wartości VAT"
    
  total_gross_amount:
    xpath: "tns:Fa/tns:Faktura/tns:Podsumowanie/tns:WartoscBrutto"
    type: "decimal"
    required: true
    description: "Suma wartości brutto"
    
  # Payment information
  payment_method:
    xpath: "tns:Fa/tns:Faktura/tns:Platnosc/tns:FormaPlatnosci"
    type: "string"
    required: false
    default: "P"
    enum: ["P", "K", "T"]
    description: "Forma płatności (P=gotówka, K=karta, T=przelew)"
    
  payment_due_date:
    xpath: "tns:Fa/tns:Faktura/tns:Platnosc/tns:TerminPlatnosci"
    type: "date"
    required: false
    format: "%Y-%m-%d"
    description: "Termin płatności"
    
  # Invoice type and status
  invoice_type:
    xpath: "tns:Fa/tns:Faktura/tns:RodzajFaktury"
    type: "string"
    required: false
    default: "VAT"
    enum: ["VAT", "KOREKTA", "ZALICZKA", "MPP"]
    description: "Rodzaj faktury"
    
  # Additional fields for specific invoice types
  original_invoice_number:
    xpath: "tns:Fa/tns:Faktura/tns:NrFakturyKorygowanej"
    type: "string"
    required: false
    description: "Numer faktury korygowanej (dla korekty)"
    
  original_invoice_date:
    xpath: "tns:Fa/tns:Faktura/tns:DataWystawieniaFakturyKorygowanej"
    type: "date"
    required: false
    format: "%Y-%m-%d"
    description: "Data wystawienia faktury korygowanej"
    
  # Currency
  currency:
    xpath: "tns:Fa/tns:Faktura/tns:Waluta"
    type: "string"
    required: false
    default: "PLN"
    description: "Waluta faktury"

# Validation rules
validation:
  # Date validation
  date_rules:
    - "issue_date <= sale_date"
    - "due_date >= issue_date"
    
  # Amount validation
  amount_rules:
    - "item_net_amount = item_quantity * item_net_price"
    - "item_vat_amount = item_net_amount * (item_vat_rate / 100)"
    - "item_gross_amount = item_net_amount + item_vat_amount"
    - "total_net_amount = sum(item_net_amount)"
    - "total_vat_amount = sum(item_vat_amount)"
    - "total_gross_amount = sum(item_gross_amount)"
    
  # VAT rate validation
  vat_rules:
    allowed_rates: [0, 5, 8, 23]
    
  # NIP validation
  nip_rules:
    pattern: "^[0-9]{10}$"
    checksum: true

# CSV column mapping (alternative to field mapping)
csv_columns:
  # Default column names that will be mapped to fields
  default_mapping:
    "Numer faktury": "invoice_number"
    "Data wystawienia": "issue_date"
    "Data sprzedaży": "sale_date"
    "Termin płatności": "due_date"
    "NIP sprzedawcy": "seller_nip"
    "Nazwa sprzedawcy": "seller_name"
    "Ulica sprzedawcy": "seller_street"
    "Miasto sprzedawcy": "seller_city"
    "Kod pocztowy sprzedawcy": "seller_postal_code"
    "NIP nabywcy": "buyer_nip"
    "Nazwa nabywcy": "buyer_name"
    "Ulica nabywcy": "buyer_street"
    "Miasto nabywcy": "buyer_city"
    "Kod pocztowy nabywcy": "buyer_postal_code"
    "Nazwa pozycji": "item_name"
    "Ilość": "item_quantity"
    "Jednostka miary": "item_unit"
    "Cena netto": "item_net_price"
    "Stawka VAT": "item_vat_rate"
    "Wartość netto": "item_net_amount"
    "Wartość VAT": "item_vat_amount"
    "Wartość brutto": "item_gross_amount"
    "Suma netto": "total_net_amount"
    "Suma VAT": "total_vat_amount"
    "Suma brutto": "total_gross_amount"
    "Forma płatności": "payment_method"
    "Rodzaj faktury": "invoice_type"
    "Waluta": "currency"
