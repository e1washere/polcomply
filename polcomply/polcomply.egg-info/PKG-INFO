Metadata-Version: 2.4
Name: polcomply
Version: 0.1.0
Summary: Polish KSeF compliance toolkit
Author-email: e1washere <e1washere@example.com>
Project-URL: Homepage, https://github.com/e1washere/polcomply
Project-URL: Repository, https://github.com/e1washere/polcomply
Project-URL: Documentation, https://github.com/e1washere/polcomply#readme
Classifier: Development Status :: 3 - Alpha
Classifier: Intended Audience :: Developers
Classifier: License :: Other/Proprietary License
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.11
Classifier: Topic :: Office/Business :: Financial :: Accounting
Classifier: Topic :: Software Development :: Libraries :: Python Modules
Requires-Python: >=3.11
Description-Content-Type: text/markdown
Requires-Dist: lxml>=4.9.0
Requires-Dist: typer[all]>=0.9.0
Requires-Dist: rich>=13.0.0
Requires-Dist: pydantic>=2.0.0
Requires-Dist: pandas>=2.0.0
Requires-Dist: pyarrow>=10.0.0
Requires-Dist: pyyaml>=6.0
Requires-Dist: openpyxl>=3.1.0
Provides-Extra: dev
Requires-Dist: pytest>=7.0.0; extra == "dev"
Requires-Dist: pytest-cov>=4.0.0; extra == "dev"
Requires-Dist: black>=23.0.0; extra == "dev"
Requires-Dist: ruff>=0.1.0; extra == "dev"
Requires-Dist: mypy>=1.0.0; extra == "dev"
Requires-Dist: pre-commit>=3.0.0; extra == "dev"

# PolComply SDK

[![CI/CD Pipeline](https://github.com/e1washere/polcomply/actions/workflows/ci.yml/badge.svg)](https://github.com/e1washere/polcomply/actions/workflows/ci.yml)
[![Python 3.11+](https://img.shields.io/badge/python-3.11+-blue.svg)](https://www.python.org/downloads/)
[![License: BSL 1.1](https://img.shields.io/badge/License-BSL%201.1-blue.svg)](LICENSE)
[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)
[![Linting: ruff](https://img.shields.io/badge/linting-ruff-yellow.svg)](https://github.com/astral-sh/ruff)
[![Type checking: mypy](https://img.shields.io/badge/type%20checking-mypy-blue.svg)](https://github.com/python/mypy)
[![Coverage](https://codecov.io/gh/e1washere/polcomply/branch/main/graph/badge.svg)](https://codecov.io/gh/e1washere/polcomply)

Polish KSeF compliance toolkit for FA-3 invoice validation and processing.

## ğŸš€ Quick Start

### Installation

**Recommended: Using `uv` (fastest)**
```bash
uv add polcomply
```

**Alternative: Using `pipx` (isolated)**
```bash
pipx install polcomply
```

**Development: Using `pip`**
```bash
pip install -e ".[dev]"
```

### CLI Examples

```bash
# Validate FA-3 XML against XSD schema
polcomply validate invoice.xml --schema schemas/FA-3.xsd

# Convert CSV to FA-3 XML
polcomply map csv-to-fa input.csv --output invoice.xml --schema schemas/FA-3.xsd

# Show validation summary
polcomply validate invoice.xml --schema schemas/FA-3.xsd --format summary

# Verbose mapping with report
polcomply map csv-to-fa data.csv --output invoice.xml --verbose
```

### Python API Examples

```python
from polcomply.validators.xsd import XSDValidator, ValidationError
from polcomply.mapping.csv_to_fa import CSVToFAMapper, MappingError

# XSD Validation
validator = XSDValidator("schemas/FA-3.xsd")
with open("invoice.xml", "rb") as f:
    errors = validator.validate(f.read())

if errors:
    for error in errors:
        print(f"Error: {error.message} (line {error.line})")
else:
    print("âœ… XML is valid!")

# CSV to FA-3 Mapping
mapper = CSVToFAMapper("mapping/fa3.yaml")
xml_content = mapper.process_csv("invoice.csv", "output.xml")
print("âœ… FA-3 XML generated!")
```

## ğŸ“‹ Command Reference

| Command | Description | Example |
|---------|-------------|---------|
| `polcomply validate <file>` | Validate XML against XSD | `polcomply validate invoice.xml --schema fa3.xsd` |
| `polcomply map csv-to-fa <csv>` | Convert CSV to FA-3 XML | `polcomply map csv-to-fa data.csv --output invoice.xml` |
| `polcomply map invoice <file>` | General invoice mapping | `polcomply map invoice data.csv --output invoice.xml` |
| `polcomply map list` | List supported formats | `polcomply map list` |
| `polcomply version` | Show version info | `polcomply version` |
| `polcomply info` | Show system info | `polcomply info` |

### Validation Options

| Option | Description | Default |
|--------|-------------|---------|
| `--schema` | XSD schema file path | Required |
| `--format` | Output format (table/json/summary) | table |
| `--verbose` | Show detailed information | False |
| `--show-xml` | Display XML content | False |

### Mapping Options

| Option | Description | Default |
|--------|-------------|---------|
| `--output` | Output XML file path | Required |
| `--config` | Mapping configuration YAML | mapping/fa3.yaml |
| `--schema` | XSD schema for validation | None |
| `--validate` | Validate output XML | True |
| `--verbose` | Show mapping report | False |

## ğŸ”§ How It Works

### XSD Validation

The SDK uses `lxml.etree.XMLSchema` for robust XML validation:

```python
# Core validation flow
1. Load XSD schema â†’ Parse XML document
2. Validate against schema â†’ Collect all errors
3. Return detailed error list â†’ No exceptions on first error
```

**Features:**
- âœ… Complete error collection (not just first error)
- âœ… Line/column position reporting
- âœ… Error code classification
- âœ… XML syntax + schema validation
- âœ… No network dependencies

### CSV to FA-3 Mapping

Intelligent mapping from CSV/Excel to FA-3 XML:

```python
# Mapping pipeline
1. Read CSV/Excel â†’ Map columns to fields
2. Validate data types â†’ Check business rules
3. Generate FA-3 XML â†’ Validate output
4. Report missing fields â†’ Show mapping details
```

**Features:**
- âœ… Flexible column mapping (YAML config)
- âœ… Type validation (string, decimal, date, array)
- âœ… Business rule validation (dates, VAT rates, amounts)
- âœ… Missing field reporting
- âœ… Support for all invoice types (VAT, KOREKTA, ZALICZKA, MPP)

### SDK Architecture

```
polcomply/
â”œâ”€â”€ validators/          # XSD validation engine
â”‚   â””â”€â”€ xsd.py          # Core validator with error collection
â”œâ”€â”€ mapping/            # CSV to FA-3 conversion
â”‚   â”œâ”€â”€ csv_to_fa.py   # Main mapper with validation
â”‚   â””â”€â”€ fa3.yaml       # Field mapping configuration
â”œâ”€â”€ cli/               # Command-line interface
â”‚   â”œâ”€â”€ main.py        # Typer-based CLI
â”‚   â””â”€â”€ commands/      # Individual commands
â””â”€â”€ tests/             # Comprehensive test suite
    â”œâ”€â”€ validators/    # XSD validator tests
    â””â”€â”€ mapping/       # Mapping tests with golden files
```

**SDK Stubs:**
- `auth/` - KSeF authentication (planned)
- `transport/` - API communication (planned)
- `client/` - High-level SDK client (planned)

## ğŸ§ª Testing

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=polcomply --cov-report=html

# Run specific test file
pytest tests/validators/test_xsd.py

# Run tests with golden files
pytest tests/validators/test_xsd.py::TestGoldenFiles

# Run mapping tests
pytest tests/mapping/test_csv_to_fa.py
```

## ğŸ”„ CI/CD Pipeline

The project uses GitHub Actions for continuous integration and deployment:

- **Lint & Format**: Black, Ruff, MyPy
- **Testing**: pytest with coverage reporting
- **Security**: Safety and Bandit scans
- **Build**: Package building and validation
- **CLI Tests**: Integration tests for command-line interface

The pipeline runs on Python 3.11 and 3.12, ensuring compatibility across versions.

## ğŸ¤ Contributing

We welcome contributions! Please follow these guidelines:

### Development Setup

```bash
# Clone repository
git clone https://github.com/e1washere/polcomply.git
cd polcomply

# Install in development mode
pip install -e ".[dev]"

# Install pre-commit hooks
pre-commit install
```

### Code Quality

**Pre-commit hooks** ensure code quality:
- **Black**: Automatic code formatting
- **Ruff**: Fast linting and import sorting
- **MyPy**: Static type checking
- **Tests**: Run tests before commit

**Type Annotations:**
- All public functions must have type hints
- Use `typing` module for complex types
- MyPy strict mode enabled

**Testing Requirements:**
- New features require tests
- Maintain 85%+ test coverage
- Use pytest fixtures for test data
- Golden files for integration tests

### Pull Request Process

1. **Fork** the repository
2. **Create** feature branch (`git checkout -b feature/amazing-feature`)
3. **Commit** changes (`git commit -m 'Add amazing feature'`)
4. **Push** to branch (`git push origin feature/amazing-feature`)
5. **Open** Pull Request

**PR Requirements:**
- âœ… All tests pass
- âœ… Code coverage maintained
- âœ… Type checking passes
- âœ… Linting passes
- âœ… Documentation updated

## ğŸ“š API Reference

### XSDValidator

```python
class XSDValidator:
    def __init__(self, schema_path: Path)
    def validate(self, xml_bytes: bytes) -> List[ValidationError]
    def validate_file(self, xml_path: Path) -> List[ValidationError]
    def is_valid(self, xml_bytes: bytes) -> bool
    def is_valid_file(self, xml_path: Path) -> bool
    def get_schema_info(self) -> Dict[str, Any]
```

### CSVToFAMapper

```python
class CSVToFAMapper:
    def __init__(self, config_path: Path)
    def read_csv(self, csv_path: Path, **kwargs) -> pd.DataFrame
    def map_columns(self, df: pd.DataFrame, column_mapping: Optional[Dict[str, str]] = None) -> pd.DataFrame
    def validate_data(self, df: pd.DataFrame) -> List[MappingError]
    def generate_xml(self, df: pd.DataFrame) -> str
    def process_csv(self, csv_path: Path, output_path: Optional[Path] = None, column_mapping: Optional[Dict[str, str]] = None) -> str
    def get_missing_fields_report(self, df: pd.DataFrame) -> Dict[str, List[Dict[str, Any]]]
```

### ValidationError

```python
class ValidationError(Exception):
    def __init__(self, message: str, line: int | None = None, column: int | None = None, code: str | None = None)
    def to_dict(self) -> Dict[str, Any]
```

### MappingError

```python
class MappingError(Exception):
    def __init__(self, message: str, field: str | None = None, row: int | None = None)
```

## ğŸš§ Limitations & Roadmap

### Current Limitations

**XSD Validation:**
- âš ï¸ Requires local XSD schema files (no remote loading)
- âš ï¸ Limited to lxml-supported XSD features
- âš ï¸ Error log iteration may vary by lxml version

**CSV Mapping:**
- âš ï¸ Single invoice per CSV file (no batch processing)
- âš ï¸ Basic business rule validation only
- âš ï¸ No support for complex nested structures
- âš ï¸ Limited Excel format support

**CLI:**
- âš ï¸ No interactive mode
- âš ï¸ Limited output format options
- âš ï¸ No progress indicators for large files

### Roadmap

**Q1 2024:**
- âœ… XSD validation engine
- âœ… CSV to FA-3 mapping
- âœ… CLI interface
- âœ… Basic test coverage

**Q2 2024:**
- ğŸ”„ KSeF API integration
- ğŸ”„ Authentication module
- ğŸ”„ Transport layer
- ğŸ”„ High-level SDK client

**Q3 2024:**
- ğŸ“‹ Batch processing support
- ğŸ“‹ Advanced business rules
- ğŸ“‹ Interactive CLI mode
- ğŸ“‹ Plugin system

**Q4 2024:**
- ğŸ“‹ Web interface
- ğŸ“‹ Database integration
- ğŸ“‹ Performance optimization
- ğŸ“‹ Enterprise features

### Known Issues

- **Test Coverage**: Currently at 59%, target is 85%
- **Golden Files**: Some test fixtures need updating
- **Type Stubs**: lxml error log iteration needs refinement
- **CLI Entry Point**: Module import issues in some environments

### Contributing to Roadmap

We welcome contributions to any roadmap items! Please:

1. **Check** existing issues and PRs
2. **Discuss** major changes in issues first
3. **Follow** the contributing guidelines
4. **Update** documentation and tests

## ğŸ“„ License

This project is licensed under the Business Source License 1.1 (BSL) - see the [LICENSE](LICENSE) file for details.

**Key Points:**
- âœ… Free for non-commercial use
- âœ… Commercial use requires license
- âœ… Converts to GPL-3.0 after 4 years
- âœ… Source code available

## ğŸ™ Acknowledgments

- **lxml** - Robust XML processing
- **Typer** - Modern CLI framework
- **Rich** - Beautiful terminal output
- **pandas** - Data manipulation
- **pytest** - Testing framework

---

**Made with â¤ï¸ for Polish tax compliance**
